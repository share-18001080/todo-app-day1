'use client'

import { useState, useEffect, useCallback } from 'react'
import { supabase, Todo } from '@/lib/supabase'
import { Plus, Trash2, Check, Circle } from 'lucide-react'

export default function TodoApp() {
  const [todos, setTodos] = useState<Todo[]>([])
    const [newTask, setNewTask] = useState('')
      const [loading, setLoading] = useState(true)

        // ✅ FIX 3: Di chuyển fetchTodos vào useCallback để tránh dependency warning
          const fetchTodos = useCallback(async () => {
              try {
                    const { data, error } = await supabase
                            .from('todos')
                                    .select('*')
                                            .order('created_at', { ascending: false })
                                                  
                                                        if (error) throw error
                                                              setTodos(data || [])
                                                                  } catch (error) {
                                                                        console.error('Error fetching todos:', error)
                                                                            } finally {
                                                                                  setLoading(false)
                                                                                      }
                                                                                        }, [])

                                                                                          // ✅ FIX 3: Bây giờ có thể safely thêm fetchTodos vào dependency array
                                                                                            useEffect(() => {
                                                                                                fetchTodos()
                                                                                                  }, [fetchTodos])

                                                                                                    const addTodo = async () => {
                                                                                                        if (!newTask.trim()) return

                                                                                                            try {
                                                                                                                  const { data, error } = await supabase
                                                                                                                          .from('todos')
                                                                                                                                  .insert({ task: newTask.trim() })
                                                                                                                                          .select()
                                                                                                                                                
                                                                                                                                                      if (error) throw error
                                                                                                                                                            if (data) {
                                                                                                                                                                    // ✅ FIX 2: Dùng functional update để tránh stale state
                                                                                                                                                                            setTodos(prevTodos => [data[0], ...prevTodos])
                                                                                                                                                                                    setNewTask('')
                                                                                                                                                                                          }
                                                                                                                                                                                              } catch (error) {
                                                                                                                                                                                                    console.error('Error adding todo:', error)
                                                                                                                                                                                                        }
                                                                                                                                                                                                          }

                                                                                                                                                                                                            const toggleComplete = async (id: number, isCompleted: boolean) => {
                                                                                                                                                                                                                try {
                                                                                                                                                                                                                      const { error } = await supabase
                                                                                                                                                                                                                              .from('todos')
                                                                                                                                                                                                                                      .update({ is_completed: !isCompleted })
                                                                                                                                                                                                                                              .eq('id', id)
                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                          if (error) throw error
                                                                                                                                                                                                                                                                // ✅ FIX 2: Dùng functional update thay vì todos.map(...)
                                                                                                                                                                                                                                                                      setTodos(prevTodos => 
                                                                                                                                                                                                                                                                              prevTodos.map(todo => 
                                                                                                                                                                                                                                                                                        todo.id === id 
                                                                                                                                                                                                                                                                                                    ? { ...todo, is_completed: !isCompleted }
                                                                                                                                                                                                                                                                                                                : todo
                                                                                                                                                                                                                                                                                                                        )
                                                                                                                                                                                                                                                                                                                              )
                                                                                                                                                                                                                                                                                                                                  } catch (error) {
                                                                                                                                                                                                                                                                                                                                        console.error('Error updating todo:', error)
                                                                                                                                                                                                                                                                                                                                            }
                                                                                                                                                                                                                                                                                                                                              }

                                                                                                                                                                                                                                                                                                                                                const deleteTodo = async (id: number) => {
                                                                                                                                                                                                                                                                                                                                                    try {
                                                                                                                                                                                                                                                                                                                                                          const { error } = await supabase
                                                                                                                                                                                                                                                                                                                                                                  .from('todos')
                                                                                                                                                                                                                                                                                                                                                                          .delete()
                                                                                                                                                                                                                                                                                                                                                                                  .eq('id', id)
                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                              if (error) throw error
                                                                                                                                                                                                                                                                                                                                                                                                    // ✅ FIX 2: Dùng functional update thay vì todos.filter(...)
                                                                                                                                                                                                                                                                                                                                                                                                          setTodos(prevTodos => prevTodos.filter(todo => todo.id !== id))
                                                                                                                                                                                                                                                                                                                                                                                                              } catch (error) {
                                                                                                                                                                                                                                                                                                                                                                                                                    console.error('Error deleting todo:', error)
                                                                                                                                                                                                                                                                                                                                                                                                                        }
                                                                                                                                                                                                                                                                                                                                                                                                                          }

                                                                                                                                                                                                                                                                                                                                                                                                                            if (loading) {
                                                                                                                                                                                                                                                                                                                                                                                                                                return (
                                                                                                                                                                                                                                                                                                                                                                                                                                      <div className="flex justify-center items-center min-h-screen">
                                                                                                                                                                                                                                                                                                                                                                                                                                              <div className="animate-spin rounded-full h-32 w-32 border-b-2 border-blue-500"></div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                    </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                        )
                                                                                                                                                                                                                                                                                                                                                                                                                                                          }

                                                                                                                                                                                                                                                                                                                                                                                                                                                            return (
                                                                                                                                                                                                                                                                                                                                                                                                                                                                <div className="max-w-md mx-auto mt-8 p-6 bg-white rounded-lg shadow-lg">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                      <h1 className="text-2xl font-bold text-center mb-6 text-gray-800">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                              My Todo App 📝
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </h1>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                {/* Add Todo Form */}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      <div className="flex gap-2 mb-6">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              <input
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        type="text"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  value={newTask}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            onChange={(e) => setNewTask(e.target.value)}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      // ✅ FIX 1: Thay onKeyPress bằng onKeyDown để bắt Enter chính xác
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                onKeyDown={(e) => e.key === 'Enter' && addTodo()}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          placeholder="Add a new task..."
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    className="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            />
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <button
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              onClick={addTodo}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        className="px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600 transition-colors"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                >
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          <Plus size={20} />
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  </button>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </div>

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              {/* Todo List */}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <div className="space-y-2">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            {todos.length === 0 ? (
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      <p className="text-gray-500 text-center py-4">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  No todos yet. Add one above! 👆
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </p>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    ) : (
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              todos.map((todo) => (
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          <div
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        key={todo.id}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      className={`flex items-center gap-3 p-3 rounded-md border ${
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      todo.is_completed 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        ? 'bg-gray-50 border-gray-200' 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          : 'bg-white border-gray-300'
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        }`}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    >
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  <button
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  onClick={() => toggleComplete(todo.id, todo.is_completed)}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  className={`flex-shrink-0 ${
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    todo.is_completed ? 'text-green-500' : 'text-gray-400'
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    }`}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  >
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  {todo.is_completed ? <Check size={20} /> : <Circle size={20} />}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </button>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <span
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            className={`flex-1 ${
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              todo.is_completed 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  ? 'line-through text-gray-500' 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      : 'text-gray-800'
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      }`}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    >
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    {todo.task}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  </span>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              <button
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              onClick={() => deleteTodo(todo.id)}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              className="flex-shrink-0 text-red-500 hover:text-red-700 transition-colors"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            >
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <Trash2 size={18} />
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          </button>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                ))
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        )}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              </div>

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    {/* Stats */}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          <div className="mt-6 text-center text-sm text-gray-500">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  {todos.length > 0 && (
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <p>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        {todos.filter(todo => !todo.is_completed).length} of {todos.length} tasks remaining
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  </p>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          )}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      )
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      